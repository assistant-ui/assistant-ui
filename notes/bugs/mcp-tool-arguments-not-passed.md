# Bug: MCP Tool Arguments Not Passed to Tools

## Summary

When using `@ai-sdk/mcp` with `streamText` from AI SDK v5, tool arguments are not being passed correctly to MCP tools. The tools are called with empty/undefined arguments despite the AI model correctly generating the arguments.

## Environment

- `@ai-sdk/mcp`: ^0.0.11
- `ai`: ^5.0.102
- `@ai-sdk/openai`: ^2.0.73
- Node.js: v22.17.1
- Next.js: 16.0.4

## Reproduction

### Files involved

1. **MCP Client** (`examples/with-mcp-tool-ui/lib/mcp-client.ts`):
```typescript
import { experimental_createMCPClient as createMCPClient } from "@ai-sdk/mcp";
import { Experimental_StdioMCPTransport as StdioMCPTransport } from "@ai-sdk/mcp/mcp-stdio";

export async function createWeatherMCPClient() {
  const client = await createMCPClient({
    transport: new StdioMCPTransport({
      command: "node",
      args: ["../mcp-weather-ui/dist/server.js"],
    }),
  });
  return client;
}
```

2. **API Route** (`examples/with-mcp-tool-ui/app/api/chat/route.ts`):
```typescript
import { openai } from "@ai-sdk/openai";
import { streamText, convertToModelMessages, UIMessage, stepCountIs } from "ai";
import { createWeatherMCPClient } from "@/lib/mcp-client";

export async function POST(req: Request) {
  const { messages }: { messages: UIMessage[] } = await req.json();

  const mcpClient = await createWeatherMCPClient();
  const tools = await mcpClient.tools();
  console.log(`[MCP] Loaded ${Object.keys(tools).length} tools`);

  const result = streamText({
    model: openai("gpt-4o"),
    messages: convertToModelMessages(messages),
    tools: tools as Parameters<typeof streamText>[0]["tools"],
    stopWhen: stepCountIs(5),
  });

  return result.toUIMessageStreamResponse();
}
```

3. **MCP Server Tool Definition** (`examples/mcp-weather-ui/src/server.ts`):
```typescript
toolWithUI({
  name: "get_weather",
  description: "Get current weather and forecast for a location.",
  parameters: z.object({
    location: z.string().describe("City name or location"),
    unit: z.enum(["celsius", "fahrenheit"]).optional().default("fahrenheit"),
  }),
  component: "WeatherCard",
  execute: async ({ location, unit }) => {
    // location is undefined here!
    const weather = await fetchWeather(location);
    return weather;
  },
});
```

### Steps to reproduce

1. Start the MCP weather server: `cd examples/mcp-weather-ui && pnpm build`
2. Start the example app: `cd examples/with-mcp-tool-ui && pnpm dev`
3. Set `OPENAI_API_KEY` in `.env`
4. Send message: "What's the weather in Tokyo?"

### Expected behavior

The `get_weather` tool should receive `{ location: "Tokyo" }` as arguments.

### Actual behavior

The tool receives `{ location: undefined }` and returns a validation error:

```
Invalid arguments: [ { "code": "invalid_type", "expected": "string", "received": "undefined", "path": [ "location" ], "message": "Required" } ]
```

## Evidence

### Console warnings

The browser console shows the arguments ARE being generated by the model:

```
[WARNING] argsText updated after controller was closed: {previous: {}, next: {"location":""}}
[WARNING] argsText updated after controller was closed: {previous: {}, next: {"location":"Tokyo"}}
[WARNING] argsText updated after controller was closed: {previous: {}, next: {"location":"Tokyo"}}
... (repeated many times)
```

This suggests:
1. The model IS generating the correct arguments (`{"location":"Tokyo"}`)
2. The arguments are being updated AFTER the controller was closed
3. The timing/lifecycle of argument passing may be the issue

### Server logs

The MCP server connects successfully and loads tools:
```
[MCP] Connecting via stdio transport
Weather MCP Server starting...
[MCP] Loaded 2 tools
POST /api/chat 200 in 4.0s
```

### Tool result format

The MCP tool returns an error in this format:
```json
{
  "content": [
    {
      "type": "text",
      "text": "Invalid arguments: [ { \"code\": \"invalid_type\", \"expected\": \"string\", \"received\": \"undefined\", \"path\": [ \"location\" ], \"message\": \"Required\" } ]"
    }
  ],
  "isError": true
}
```

## Hypothesis

The warning `argsText updated after controller was closed` suggests a race condition or lifecycle issue where:

1. The stream controller is closed before the tool arguments are fully populated
2. The MCP tool execution starts before arguments are ready
3. There may be a timing issue between streaming argument deltas and tool invocation

## Questions for investigation

1. Is there a specific way MCP tools need to be configured with `streamText` to handle argument streaming?
2. Should `mcpClient.tools()` return tools in a different format for AI SDK v5?
3. Is there a lifecycle hook or callback needed to wait for arguments to be complete before tool execution?
4. Does this work correctly with non-MCP tools defined inline?

## Upstream Investigation (2024-12-25)

**Good news**: This issue has been noticed and partially addressed in upstream.

### Relevant commits found:

1. **`fc783415` - `chore(release): bump react package to 0.11.32 and fix tool args (#2632)`** (Oct 20, 2025)
   - This is the primary fix for the warning we're seeing
   - Added `argsComplete` tracking to prevent appending after args stream is closed
   - Changed behavior from **crashing** to **logging a warning** in non-production
   - File changed: `packages/react/src/legacy-runtime/runtime-cores/assistant-transport/useToolInvocations.ts`

2. **`7919352c` - `fix: better partial tool call args parsing (#2474)`**

3. **`3c7126a1` - `fix: do not close assistant stream tool call args text controller early (#1791)`**

4. **`439ae67a` - `fix: properly emit tool-call args-text finish (#1762)`**

### Current status:

The fix in `fc783415` is **already in our codebase**. The warning `argsText updated after controller was closed` is the **result of this fix** - it changed the behavior from throwing an error to logging a warning.

However, **the root cause is NOT in assistant-ui** - it's in `@ai-sdk/mcp`. The `@ai-sdk/mcp` package is sending tool call updates after the args stream has already been closed. The assistant-ui fix just makes it more tolerant of this behavior.

### Next steps for investigation:

1. Check the `@ai-sdk/mcp` package (Vercel's AI SDK) for related issues/PRs
2. The bug may need to be reported to the AI SDK repository: https://github.com/vercel/ai
3. The issue is likely in how `experimental_createMCPClient` bridges MCP tool calls to the AI SDK streaming format

## Workaround: Native MCP Client (SUCCESSFUL)

A working workaround has been implemented that bypasses `@ai-sdk/mcp` entirely by using the native `@modelcontextprotocol/sdk` directly.

### Solution files:

1. **`examples/with-mcp-tool-ui/lib/mcp-client-native.ts`** - Native MCP client implementation:

```typescript
import { Client } from "@modelcontextprotocol/sdk/client/index.js";
import { StdioClientTransport } from "@modelcontextprotocol/sdk/client/stdio.js";
import { tool, jsonSchema } from "ai";
import type { JSONSchema7 } from "json-schema";

export async function createNativeMCPClient() {
  const transport = new StdioClientTransport({
    command: "node",
    args: ["../mcp-weather-ui/dist/server.js"],
  });

  const client = new Client(
    { name: "with-mcp-tool-ui", version: "1.0.0" },
    { capabilities: {} }
  );

  await client.connect(transport);
  const { tools: mcpTools } = await client.listTools();

  const aiSdkTools: Record<string, ReturnType<typeof tool>> = {};

  for (const mcpTool of mcpTools) {
    const schema = mcpTool.inputSchema as JSONSchema7;
    const { $schema, ...cleanSchema } = schema;

    aiSdkTools[mcpTool.name] = tool({
      description: mcpTool.description || "",
      inputSchema: jsonSchema(cleanSchema),  // Use inputSchema, not parameters!
      execute: async (args) => {
        const result = await client.callTool({
          name: mcpTool.name,
          arguments: args as Record<string, unknown>,
        });
        return result;
      },
    });
  }

  return {
    tools: () => aiSdkTools,
    close: async () => await client.close(),
  };
}
```

### Key points:
- Use `@modelcontextprotocol/sdk` directly instead of `@ai-sdk/mcp`
- Use `jsonSchema()` from AI SDK to wrap the MCP tool's JSON Schema
- **Critical**: Use `inputSchema` property, NOT `parameters` (AI SDK v5 change)
- This successfully passes arguments to MCP tools

### Result:
- Tool arguments are now correctly passed (e.g., `{"location":"Tokyo","unit":"celsius"}`)
- Weather cards render with proper data
- No more "argsText updated after controller was closed" warnings

## Related files

- `examples/with-mcp-tool-ui/` - Full example demonstrating the issue
- `examples/mcp-weather-ui/` - MCP server with tool definitions
- Screenshots in `.playwright-mcp/`:
  - `weather-error-handling.png` - Shows the error UI

## Contact

Created: 2024-12-24
Example location: `examples/with-mcp-tool-ui/`
